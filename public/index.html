<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –ü—Ä–∏–Ω—è—Ç–∏—è –ê–≥—Ä–æ —Ä–µ—à–µ–Ω–∏–∏ –ø–æ —Å–ø—É—Ç–Ω–∏–∫—É</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- OpenLayers for the map -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.1.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.1.0/dist/ol.js"></script>

    <style>
        #map { height: 100vh; width: 100%; cursor: crosshair; background: #1a202c; }
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        #info-panel::-webkit-scrollbar { width: 6px; }
        #info-panel::-webkit-scrollbar-track { background: #2d3748; }
        #info-panel::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 3px; }
        .lang-btn.active { background-color: #38b2ac; color: white; }
        .ol-attribution { display: none; }
        .toggle-checkbox:checked { right: 0; border-color: #38b2ac; }
        .toggle-checkbox:checked + .toggle-label { background-color: #38b2ac; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    
    <div id="map" class="relative">
        <div id="info-panel" class="absolute top-4 left-4 z-[1000] w-full max-w-sm p-4 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-lg shadow-2xl transition-all duration-300 max-h-[calc(100vh-2rem)] overflow-y-auto">
            
            <div class="absolute top-3 right-3 flex space-x-1 bg-gray-700 rounded-lg p-1">
                <button id="lang-kk" class="lang-btn px-2 py-1 text-xs font-semibold rounded-md transition-colors">“ö–ê–ó</button>
                <button id="lang-ru" class="lang-btn px-2 py-1 text-xs font-semibold rounded-md transition-colors">–†–£–°</button>
            </div>

            <h1 data-translate-key="title" class="text-xl font-bold text-cyan-400 mb-2 text-center"></h1>
            <p data-translate-key="subtitle" class="text-gray-300 text-sm mb-3 text-center"></p>
            
            <div class="bg-gray-900 rounded-md p-3 text-lg font-mono tracking-wider text-green-400 text-center mb-3">
                <span id="coords"></span>
            </div>
            
            <div class="mb-4">
                <h2 data-translate-key="ndvi_title" class="text-lg font-semibold text-cyan-300 mb-2"></h2>
                <div class="bg-gray-900 rounded-md p-3 space-y-3">
                    <div class="flex items-center justify-between">
                        <span data-translate-key="show_ndvi_layer" class="text-gray-200"></span>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="ndvi-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="ndvi-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-gray-700">
                        <span data-translate-key="ndvi_value" class="text-gray-200"></span>
                        <span id="ndvi-value-display" class="font-mono text-lg text-green-400">-</span>
                    </div>
                    <div id="ndvi-legend" class="hidden mt-3">
                        <div class="w-full h-4 rounded-md bg-gradient-to-r from-yellow-800 via-yellow-500 to-green-500"></div>
                        <div class="flex justify-between text-xs text-gray-400 mt-1">
                            <span data-translate-key="low"></span>
                            <span data-translate-key="high"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h2 data-translate-key="current_weather_title" class="text-lg font-semibold text-cyan-300 mb-2"></h2>
                <div id="weather-container" class="bg-gray-900 rounded-md p-3 text-base text-gray-200 min-h-[100px] flex items-center justify-center">
                    <p data-translate-key="weather_placeholder" class="text-center text-gray-400"></p>
                </div>
            </div>

            <div>
                <h2 data-translate-key="forecast_title" class="text-lg font-semibold text-cyan-300 mb-2"></h2>
                <div id="forecast-container" class="bg-gray-900 rounded-md p-3 space-y-2 min-h-[150px] flex flex-col justify-center">
                     <p data-translate-key="forecast_placeholder" class="text-center text-gray-400"></p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- START: SHARED LOGIC ---
        const translations = {
            kk: { title: "–°–ø—É—Ç–Ω–∏–∫—Ç—ñ–∫ –ê–≥—Ä–æ –±–æ–ª–∂–∞“ì—ã—à", subtitle: "–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä –º–µ–Ω –∞—É–∞ —Ä–∞–π—ã –±–æ–ª–∂–∞–º—ã–Ω –∞–ª—É “Ø—à—ñ–Ω –∫–∞—Ä—Ç–∞–Ω—ã –±–∞—Å—ã“£—ã–∑.", coords_placeholder: "–ö–∞—Ä—Ç–∞–Ω—ã –±–∞—Å—ã“£—ã–∑...", current_weather_title: "–ê“ì—ã–º–¥–∞“ì—ã –∞—É–∞-—Ä–∞–π—ã", forecast_title: "16 –∫“Ø–Ω–¥—ñ–∫ –±–æ–ª–∂–∞–º", weather_placeholder: "–ê—É–∞-—Ä–∞–π—ã –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ –æ—Å—ã–Ω–¥–∞ –ø–∞–π–¥–∞ –±–æ–ª–∞–¥—ã.", forecast_placeholder: "–ë–æ–ª–∂–∞–º –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ –æ—Å—ã–Ω–¥–∞ –ø–∞–π–¥–∞ –±–æ–ª–∞–¥—ã.", fetching_current: "–ê“ì—ã–º–¥–∞“ì—ã –∞—É–∞-—Ä–∞–π—ã –∞–ª—ã–Ω—É–¥–∞...", fetching_forecast: "–ë–æ–ª–∂–∞–º –∞–ª—ã–Ω—É–¥–∞...", error_current: "–ê“ì—ã–º–¥–∞“ì—ã –∞—É–∞-—Ä–∞–π—ã–Ω –∞–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.", error_forecast: "–ë–æ–ª–∂–∞–º–¥—ã –∞–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.", temp: "–¢–µ–º–ø", humidity: "–´–ª“ì–∞–ª–¥—ã–ª—ã“õ", precip: "–ñ–∞—É—ã–Ω", wind: "–ñ–µ–ª", ndvi_title: "”®—Å—ñ–º–¥—ñ–∫ –∏–Ω–¥–µ–∫—Å—ñ (NDVI)", show_ndvi_layer: "NDVI “õ–∞–±–∞—Ç—ã–Ω –∫”©—Ä—Å–µ—Ç—É", low: "–¢”©–º–µ–Ω", high: "–ñ–æ“ì–∞—Ä—ã", ndvi_value: "–ù“Ø–∫—Ç–µ–¥–µ–≥—ñ –º”ô–Ω:", fetching_ndvi: "–ê–ª—ã–Ω—É–¥–∞...", ndvi_no_data: "–î–µ—Ä–µ–∫—Ç–µ—Ä –∂–æ“õ", weather_codes: { 0: "–ê—à—ã“õ –∞—Å–ø–∞–Ω", 1: "–ù–µ–≥—ñ–∑—ñ–Ω–µ–Ω –∞—à—ã“õ", 2: "–ñ–∞—Ä—Ç—ã–ª–∞–π –±“±–ª—Ç—Ç—ã", 3: "–ë“±–ª—Ç—Ç—ã", 45: "–¢“±–º–∞–Ω", 48: "“ö—ã—Ä–∞—É–ª—ã —Ç“±–º–∞–Ω", 51: "–ñ–µ“£—ñ–ª —Å—ñ—Ä–∫—ñ—Ä–µ—É", 53: "–°—ñ—Ä–∫—ñ—Ä–µ—É", 55: "“ö–æ—é —Å—ñ—Ä–∫—ñ—Ä–µ—É", 61: "–ñ–µ“£—ñ–ª –∂–∞“£–±—ã—Ä", 63: "–ñ–∞“£–±—ã—Ä", 65: "–ù”©—Å–µ—Ä –∂–∞“£–±—ã—Ä", 80: "–ñ–µ“£—ñ–ª –∂–∞—É—ã–Ω", 81: "–ñ–∞—É—ã–Ω", 82: "“ö–∞—Ç—Ç—ã –∂–∞—É—ã–Ω", 95: "–ù–∞–π–∑–∞“ì–∞–π" } },
            ru: { title: "–°–ø—É—Ç–Ω–∏–∫–æ–≤—ã–π –ê–≥—Ä–æ –ü—Ä–æ–≥–Ω–æ–∑", subtitle: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã.", coords_placeholder: "–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É...", current_weather_title: "–¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞", forecast_title: "–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 16 –¥–Ω–µ–π", weather_placeholder: "–î–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.", forecast_placeholder: "–î–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.", fetching_current: "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã...", fetching_forecast: "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞...", error_current: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É.", error_forecast: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑.", temp: "–¢–µ–º–ø", humidity: "–í–ª–∞–∂–Ω–æ—Å—Ç—å", precip: "–û—Å–∞–¥–∫–∏", wind: "–í–µ—Ç–µ—Ä", ndvi_title: "–ò–Ω–¥–µ–∫—Å –†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (NDVI)", show_ndvi_layer: "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ–π NDVI", low: "–ù–∏–∑–∫–∏–π", high: "–í—ã—Å–æ–∫–∏–π", ndvi_value: "–ó–Ω–∞—á–µ–Ω–∏–µ –≤ —Ç–æ—á–∫–µ:", fetching_ndvi: "–ü–æ–ª—É—á–µ–Ω–∏–µ...", ndvi_no_data: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", weather_codes: { 0: "–ß–∏—Å—Ç–æ–µ –Ω–µ–±–æ", 1: "–í –æ—Å–Ω–æ–≤–Ω–æ–º —è—Å–Ω–æ", 2: "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å", 3: "–ü–∞—Å–º—É—Ä–Ω–æ", 45: "–¢—É–º–∞–Ω", 48: "–ò–∑–º–æ—Ä–æ–∑—å", 51: "–õ–µ–≥–∫–∞—è –º–æ—Ä–æ—Å—å", 53: "–ú–æ—Ä–æ—Å—å", 55: "–ì—É—Å—Ç–∞—è –º–æ—Ä–æ—Å—å", 61: "–ù–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å", 63: "–î–æ–∂–¥—å", 65: "–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å", 80: "–ù–µ–±–æ–ª—å—à–∏–µ –ª–∏–≤–Ω–∏", 81: "–õ–∏–≤–Ω–∏", 82: "–°–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏", 95: "–ì—Ä–æ–∑–∞" } }
        };
        let currentLang = 'kk';
        let lastClickedLatLng = null;
        let lastWeatherData = null;

        const ui = { coords: document.getElementById('coords'), weather: document.getElementById('weather-container'), forecast: document.getElementById('forecast-container'), langKk: document.getElementById('lang-kk'), langRu: document.getElementById('lang-ru'), ndviToggle: document.getElementById('ndvi-toggle'), ndviLegend: document.getElementById('ndvi-legend'), ndviValue: document.getElementById('ndvi-value-display') };
        
        function setLanguage(lang) {
            currentLang = lang; document.documentElement.lang = lang;
            ui.langKk.classList.toggle('active', lang === 'kk'); ui.langRu.classList.toggle('active', lang === 'ru');
            document.querySelectorAll('[data-translate-key]').forEach(el => { el.textContent = translations[lang][el.dataset.translateKey]; });
            if (!lastClickedLatLng) { ui.coords.textContent = translations[lang].coords_placeholder; }
            if (lastWeatherData) { displayCurrentWeather(lastWeatherData.current, lastWeatherData.current_units); displayForecast(lastWeatherData.daily); }
        }

        function getWeatherInfo(code) { const icons = { 0:"‚òÄÔ∏è", 1:"üå§Ô∏è", 2:"‚õÖ", 3:"‚òÅÔ∏è", 45:"üå´Ô∏è", 48:"üå´Ô∏è", 51:"üíß", 53:"üíß", 55:"üíß", 61:"üåßÔ∏è", 63:"üåßÔ∏è", 65:"üåßÔ∏è", 80:"üå¶Ô∏è", 81:"üå¶Ô∏è", 82:"üå¶Ô∏è", 95:"‚õàÔ∏è" }; return { description: translations[currentLang].weather_codes[code] || "Unknown", icon: icons[code] || "ü§∑" }; }
        function displayCurrentWeather(current, units) { if (!current) return; const { description, icon } = getWeatherInfo(current.weather_code); const t = translations[currentLang]; ui.weather.innerHTML = `<div class="grid grid-cols-2 gap-4 w-full"><div class="flex flex-col items-center justify-center text-center col-span-2"><span class="text-4xl">${icon}</span><span class="font-semibold">${description}</span></div><div class="text-center"><span class="text-gray-400 text-sm block">${t.temp}</span><span class="font-bold text-xl">${current.temperature_2m}${units.temperature_2m}</span></div><div class="text-center"><span class="text-gray-400 text-sm block">${t.humidity}</span><span class="font-bold text-xl">${current.relative_humidity_2m}${units.relative_humidity_2m}</span></div><div class="text-center"><span class="text-gray-400 text-sm block">${t.precip}</span><span class="font-bold text-xl">${current.precipitation}${units.precipitation}</span></div><div class="text-center"><span class="text-gray-400 text-sm block">${t.wind}</span><span class="font-bold text-xl">${current.wind_speed_10m} ${units.wind_speed_10m}</span></div></div>`; }
        function displayForecast(daily) { ui.forecast.innerHTML = ''; if (!daily || !daily.time || daily.time.length === 0) { ui.forecast.innerHTML = `<p class="text-center text-gray-400">${translations[currentLang].forecast_placeholder}</p>`; return; } daily.time.forEach((dateStr, i) => { const date = new Date(dateStr); const locale = currentLang === 'kk' ? 'kk-KZ' : 'ru-RU'; const day = date.toLocaleDateString(locale, { weekday: 'short' }); const { icon } = getWeatherInfo(daily.weather_code[i]); const maxTemp = Math.round(daily.temperature_2m_max[i]); const minTemp = Math.round(daily.temperature_2m_min[i]); const item = document.createElement('div'); item.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-700'; item.innerHTML = `<div class="flex items-center gap-3"><span class="text-xl w-8 text-center">${icon}</span><div><p class="font-semibold">${day}</p><p class="text-xs text-gray-400">${`${date.getDate()}/${date.getMonth() + 1}`}</p></div></div><div><span class="font-medium">${maxTemp}¬∞</span><span class="text-gray-400"> / ${minTemp}¬∞</span></div>`; ui.forecast.appendChild(item); }); }
        ui.langKk.addEventListener('click', () => setLanguage('kk'));
        ui.langRu.addEventListener('click', () => setLanguage('ru'));
        
        // --- START: OPENLAYERS MAP LOGIC ---
        const markerSource = new ol.source.Vector();
        const markerLayer = new ol.layer.Vector({ source: markerSource, style: new ol.style.Style({ image: new ol.style.Icon({ anchor: [0.5, 1], src: `data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32"><path fill="%2338b2ac" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>` }) }), });

        // GEE NDVI layer, pointing to our own serverless function
        const ndviLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: '/api/get-ndvi-tiles?z={z}&x={x}&y={y}', // URL points to our backend
                attributions: 'NDVI ¬© Google Earth Engine',
            }),
            opacity: 0.7,
            visible: false
        });

        const map = new ol.Map({ target: 'map', layers: [ new ol.layer.Tile({ source: new ol.source.XYZ({ url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}' }) }), ndviLayer, markerLayer ], view: new ol.View({ center: ol.proj.fromLonLat([69.14, 54.87]), zoom: 7 }), controls: [], });

        async function fetchWeatherData(lat, lng) { ui.weather.innerHTML = `<p class="text-center text-yellow-400">${translations[currentLang].fetching_current}</p>`; ui.forecast.innerHTML = `<p class="text-center text-yellow-400">${translations[currentLang].fetching_forecast}</p>`; const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&forecast_days=16`; try { const response = await fetch(apiUrl); if (!response.ok) throw new Error('Network response failed'); lastWeatherData = await response.json(); displayCurrentWeather(lastWeatherData.current, lastWeatherData.current_units); displayForecast(lastWeatherData.daily); } catch (error) { lastWeatherData = null; ui.weather.innerHTML = `<p class="text-center text-red-400">${translations[currentLang].error_current}</p>`; ui.forecast.innerHTML = `<p class="text-center text-red-400">${translations[currentLang].error_forecast}</p>`; } }

        async function fetchNdviData(lat, lng) {
            ui.ndviValue.textContent = translations[currentLang].fetching_ndvi;
            try {
                // FIX: Changed parameter name from 'lng' to 'lon' to match the backend API.
                const response = await fetch(`/api/get-ndvi-value?lat=${lat}&lon=${lng}`);
                if (!response.ok) throw new Error('Failed to fetch NDVI value from server');
                const data = await response.json();
                if (data.ndvi !== null && typeof data.ndvi !== 'undefined') {
                    ui.ndviValue.textContent = data.ndvi.toFixed(3);
                } else {
                    ui.ndviValue.textContent = translations[currentLang].ndvi_no_data;
                }
            } catch (error) {
                console.error("NDVI Value Fetch Error:", error);
                ui.ndviValue.textContent = translations[currentLang].ndvi_no_data;
            }
        }

        map.on('singleclick', function(e) {
            const [lng, lat] = ol.proj.toLonLat(e.coordinate);
            lastClickedLatLng = { lat, lng };
            ui.coords.innerHTML = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
            markerSource.clear();
            markerSource.addFeature(new ol.Feature({ geometry: new ol.geom.Point(e.coordinate) }));
            fetchWeatherData(lat, lng);
            fetchNdviData(lat, lng);
        });
        
        ui.ndviToggle.addEventListener('change', function() { ndviLayer.setVisible(this.checked); ui.ndviLegend.classList.toggle('hidden', !this.checked); });
        setLanguage('kk');
    </script>

</body>
</html>

